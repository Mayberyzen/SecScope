from PyQt6.QtCore import QThread, pyqtSignal, QObject
from PyQt6.QtWidgets import (
    QWidget,
    QVBoxLayout,
    QHBoxLayout,
    QLineEdit,
    QPushButton,
    QLabel,
    QGroupBox,
    QPlainTextEdit,
    QFormLayout,
    QSpinBox,
)

from modules import pentest_tools


class PentestWorker(QObject):
    finished = pyqtSignal(str)
    error = pyqtSignal(str)

    def __init__(self, func, *args, **kwargs):
        super().__init__()
        self.func = func
        self.args = args
        self.kwargs = kwargs

    def run(self):
        try:
            result = self.func(*self.args, **self.kwargs)
        except Exception as e:
            self.error.emit(str(e))
            return

        # Convert common types to string
        if isinstance(result, dict):
            text = "\n".join(f"{k}: {v}" for k, v in result.items())
        elif isinstance(result, list):
            text = "\n".join(str(x) for x in result)
        else:
            text = str(result)
        self.finished.emit(text)


class PentestToolsTab(QWidget):
    def __init__(self, parent=None):
        super().__init__(parent)
        self._build_ui()

    def _build_ui(self):
        main_layout = QVBoxLayout(self)

        # Ping
        ping_group = QGroupBox("Ping")
        ping_layout = QHBoxLayout()
        self.ping_target_edit = QLineEdit()
        self.ping_target_edit.setPlaceholderText("host or IP")
        ping_btn = QPushButton("Ping")
        ping_layout.addWidget(self.ping_target_edit)
        ping_layout.addWidget(ping_btn)
        ping_group.setLayout(ping_layout)

        # Traceroute
        trace_group = QGroupBox("Traceroute")
        trace_layout = QHBoxLayout()
        self.trace_target_edit = QLineEdit()
        self.trace_target_edit.setPlaceholderText("host or IP")
        trace_btn = QPushButton("Traceroute")
        trace_layout.addWidget(self.trace_target_edit)
        trace_layout.addWidget(trace_btn)
        trace_group.setLayout(trace_layout)

        # Port scan
        port_group = QGroupBox("Port Scan")
        port_layout = QFormLayout()
        self.port_host_edit = QLineEdit()
        self.port_host_edit.setPlaceholderText("host or IP")
        self.port_start_spin = QSpinBox()
        self.port_start_spin.setRange(1, 65535)
        self.port_start_spin.setValue(1)
        self.port_end_spin = QSpinBox()
        self.port_end_spin.setRange(1, 65535)
        self.port_end_spin.setValue(1024)
        port_btn = QPushButton("Scan Ports")
        port_layout.addRow("Host:", self.port_host_edit)
        port_layout.addRow("Start port:", self.port_start_spin)
        port_layout.addRow("End port:", self.port_end_spin)
        port_layout.addRow(port_btn)
        port_group.setLayout(port_layout)

        # Banner grab
        banner_group = QGroupBox("Banner Grab")
        banner_layout = QFormLayout()
        self.banner_host_edit = QLineEdit()
        self.banner_host_edit.setPlaceholderText("host or IP")
        self.banner_port_spin = QSpinBox()
        self.banner_port_spin.setRange(1, 65535)
        self.banner_port_spin.setValue(80)
        banner_btn = QPushButton("Grab Banner")
        banner_layout.addRow("Host:", self.banner_host_edit)
        banner_layout.addRow("Port:", self.banner_port_spin)
        banner_layout.addRow(banner_btn)
        banner_group.setLayout(banner_layout)

        # Subdomain enum
        sub_group = QGroupBox("Subdomain Enumeration (VERY basic)")
        sub_layout = QFormLayout()
        self.sub_domain_edit = QLineEdit()
        self.sub_domain_edit.setPlaceholderText("example.com")
        self.sub_wordlist_edit = QLineEdit()
        self.sub_wordlist_edit.setPlaceholderText("www,mail,dev,test")
        sub_btn = QPushButton("Enumerate")
        sub_layout.addRow("Domain:", self.sub_domain_edit)
        sub_layout.addRow("Subdomains (comma-separated):", self.sub_wordlist_edit)
        sub_layout.addRow(sub_btn)
        sub_group.setLayout(sub_layout)

        # Directory brute-force (tiny)
        dir_group = QGroupBox("Directory Brute-force (tiny)")
        dir_layout = QFormLayout()
        self.dir_base_url_edit = QLineEdit()
        self.dir_base_url_edit.setPlaceholderText("https://example.com")
        self.dir_wordlist_edit = QLineEdit()
        self.dir_wordlist_edit.setPlaceholderText("admin,login,uploads")
        dir_btn = QPushButton("Run")
        dir_layout.addRow("Base URL:", self.dir_base_url_edit)
        dir_layout.addRow("Paths (comma-separated):", self.dir_wordlist_edit)
        dir_layout.addRow(dir_btn)
        dir_group.setLayout(dir_layout)

        # Output
        self.output_box = QPlainTextEdit()
        self.output_box.setReadOnly(True)

        main_layout.addWidget(ping_group)
        main_layout.addWidget(trace_group)
        main_layout.addWidget(port_group)
        main_layout.addWidget(banner_group)
        main_layout.addWidget(sub_group)
        main_layout.addWidget(dir_group)
        main_layout.addWidget(QLabel("Output:"))
        main_layout.addWidget(self.output_box)

        # Connect buttons
        ping_btn.clicked.connect(self._do_ping)
        trace_btn.clicked.connect(self._do_traceroute)
        port_btn.clicked.connect(self._do_port_scan)
        banner_btn.clicked.connect(self._do_banner_grab)
        sub_btn.clicked.connect(self._do_sub_enum)
        dir_btn.clicked.connect(self._do_dir_bruteforce)

    # --- Helpers ---

    def _run_in_thread(self, func, *args, **kwargs):
        self.output_box.setPlainText("Running...")
        thread = QThread(self)
        worker = PentestWorker(func, *args, **kwargs)
        worker.moveToThread(thread)

        thread.started.connect(worker.run)
        worker.finished.connect(lambda text: self._on_result(thread, worker, text))
        worker.error.connect(lambda err: self._on_error(thread, worker, err))
        worker.finished.connect(thread.quit)
        worker.error.connect(thread.quit)
        thread.finished.connect(worker.deleteLater)
        thread.finished.connect(thread.deleteLater)

        thread.start()

    def _on_result(self, thread, worker, text: str):
        self.output_box.setPlainText(text)

    def _on_error(self, thread, worker, err: str):
        self.output_box.setPlainText(f"Error: {err}")

    # --- Actions ---

    def _do_ping(self):
        target = self.ping_target_edit.text().strip()
        if not target:
            return
        self._run_in_thread(pentest_tools.ping_host, target)

    def _do_traceroute(self):
        target = self.trace_target_edit.text().strip()
        if not target:
            return
        self._run_in_thread(pentest_tools.traceroute_host, target)

    def _do_port_scan(self):
        host = self.port_host_edit.text().strip()
        if not host:
            return
        start = self.port_start_spin.value()
        end = self.port_end_spin.value()
        if end < start:
            start, end = end, start
        ports = list(range(start, end + 1))
        self._run_in_thread(pentest_tools.scan_ports, host, ports)

    def _do_banner_grab(self):
        host = self.banner_host_edit.text().strip()
        if not host:
            return
        port = self.banner_port_spin.value()
        self._run_in_thread(pentest_tools.banner_grab, host, port)

    def _do_sub_enum(self):
        domain = self.sub_domain_edit.text().strip()
        if not domain:
            return
        raw = self.sub_wordlist_edit.text().strip()
        wordlist = [w.strip() for w in raw.split(",") if w.strip()] or ["www", "mail", "dev"]
        self._run_in_thread(pentest_tools.enumerate_subdomains, domain, wordlist)

    def _do_dir_bruteforce(self):
        base_url = self.dir_base_url_edit.text().strip()
        if not base_url:
            return
        raw = self.dir_wordlist_edit.text().strip()
        wordlist = [w.strip() for w in raw.split(",") if w.strip()] or ["admin", "login", "uploads"]
        self._run_in_thread(pentest_tools.dir_bruteforce, base_url, wordlist)
